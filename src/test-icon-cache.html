<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾æ ‡ç¼“å­˜æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .bookmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .bookmark-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .bookmark-item:hover {
            transform: scale(1.05);
        }
        .bookmark-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            position: relative;
        }
        .bookmark-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .bookmark-icon.loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .bookmark-title {
            font-size: 12px;
            color: #333;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .test-controls {
            margin: 20px 0;
        }
        .test-controls button {
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        .test-controls button:hover {
            background: #0056b3;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .cache-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .cache-stat {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
        }
        .cache-stat strong {
            color: #495057;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š å›¾æ ‡ç¼“å­˜æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>ğŸ¯ æˆåŠŸURLè®°å¿†æµ‹è¯•</h2>
        <p>è¿™ä¸ªæµ‹è¯•ä¼šéªŒè¯å›¾æ ‡çš„æˆåŠŸURLè®°å¿†åŠŸèƒ½ã€‚é¦–æ¬¡åŠ è½½éœ€è¦å°è¯•å¤šä¸ªURLï¼Œä¹‹ååº”è¯¥ç›´æ¥ä½¿ç”¨æˆåŠŸçš„URLã€‚</p>
        
        <div class="test-controls">
            <button onclick="testBookmarks()">ğŸš€ æµ‹è¯•ä¹¦ç­¾å›¾æ ‡</button>
            <button onclick="clearCache()">ğŸ—‘ï¸ æ¸…ç©ºç¼“å­˜</button>
            <button onclick="showCacheStats()">ğŸ“ˆ æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡</button>
            <button onclick="testSingleIcon()">ğŸ” æµ‹è¯•å•ä¸ªå›¾æ ‡</button>
        </div>
        
        <div class="cache-stats" id="cacheStats"></div>
        
        <div class="bookmark-grid" id="bookmarkGrid"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <div class="log-output" id="logOutput"></div>
    </div>

    <script>
        // æµ‹è¯•ä¹¦ç­¾æ•°æ®
        const testBookmarks = [
            { title: 'Google', url: 'https://www.google.com' },
            { title: 'GitHub', url: 'https://github.com' },
            { title: 'Stack Overflow', url: 'https://stackoverflow.com' },
            { title: 'MDN', url: 'https://developer.mozilla.org' },
            { title: 'Baidu', url: 'https://www.baidu.com' },
            { title: 'Zhihu', url: 'https://www.zhihu.com' },
        ];

        let logContainer = null;
        let originalConsoleLog = null;

        // åˆå§‹åŒ–æ—¥å¿—æ‹¦æˆª
        function initializeLogging() {
            logContainer = document.getElementById('logOutput');
            originalConsoleLog = console.log;
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                if (logContainer) {
                    const timestamp = new Date().toLocaleTimeString();
                    logContainer.textContent += `[${timestamp}] ${message}\n`;
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            };
        }

        // æ¨¡æ‹Ÿå›¾æ ‡åŠ è½½å‡½æ•°
        async function loadIcon(url, size = 32) {
            console.log(`ğŸ”„ å¼€å§‹åŠ è½½å›¾æ ‡: ${url}`);
            
            // æ¨¡æ‹Ÿæ£€æŸ¥éªŒè¯ç¼“å­˜
            const cached = localStorage.getItem(`icon_cache_${url}_${size}`);
            if (cached) {
                const cacheData = JSON.parse(cached);
                if (cacheData.isValidated && Date.now() - cacheData.timestamp < 7 * 24 * 60 * 60 * 1000) {
                    console.log(`ğŸ¯ ä½¿ç”¨å·²éªŒè¯ç¼“å­˜: ${url} -> ${cacheData.iconUrl}`);
                    return cacheData.iconUrl;
                }
            }
            
            // æ¨¡æ‹Ÿfallback URLæµ‹è¯•
            const fallbackUrls = [
                `${new URL(url).origin}/favicon.ico`,
                `${new URL(url).origin}/favicon.png`,
                `${new URL(url).origin}/apple-touch-icon.png`,
                `https://icons.duckduckgo.com/ip3/${new URL(url).hostname}.ico`,
            ];
            
            for (let i = 0; i < fallbackUrls.length; i++) {
                const testUrl = fallbackUrls[i];
                console.log(`ğŸ”„ å°è¯•URL (${i + 1}/${fallbackUrls.length}): ${testUrl}`);
                
                try {
                    const success = await testImageUrl(testUrl);
                    if (success) {
                        console.log(`ğŸ’¾ ä¿å­˜æˆåŠŸURLåˆ°éªŒè¯ç¼“å­˜: ${url} -> ${testUrl}`);
                        
                        // ä¿å­˜åˆ°éªŒè¯ç¼“å­˜
                        localStorage.setItem(`icon_cache_${url}_${size}`, JSON.stringify({
                            iconUrl: testUrl,
                            timestamp: Date.now(),
                            isValidated: true
                        }));
                        
                        return testUrl;
                    }
                } catch (e) {
                    console.log(`âŒ URLå¤±è´¥: ${testUrl}`);
                }
            }
            
            console.log(`ğŸ’¥ æ‰€æœ‰fallback URLéƒ½å¤±è´¥äº†: ${url}`);
            return null;
        }

        // æµ‹è¯•å›¾ç‰‡URLæ˜¯å¦å¯ç”¨
        function testImageUrl(url, timeout = 3000) {
            return new Promise((resolve) => {
                const img = new Image();
                const timer = setTimeout(() => resolve(false), timeout);
                
                img.onload = () => {
                    clearTimeout(timer);
                    resolve(img.width > 1 && img.height > 1);
                };
                
                img.onerror = () => {
                    clearTimeout(timer);
                    resolve(false);
                };
                
                img.src = url;
            });
        }

        // æ¸²æŸ“ä¹¦ç­¾å›¾æ ‡
        function renderBookmarkIcon(bookmark, container) {
            const item = document.createElement('div');
            item.className = 'bookmark-item';
            
            const icon = document.createElement('div');
            icon.className = 'bookmark-icon loading';
            
            const title = document.createElement('div');
            title.className = 'bookmark-title';
            title.textContent = bookmark.title;
            title.title = bookmark.url;
            
            item.appendChild(icon);
            item.appendChild(title);
            container.appendChild(item);
            
            // å¼€å§‹åŠ è½½å›¾æ ‡
            const startTime = performance.now();
            loadIcon(bookmark.url).then(iconUrl => {
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(2);
                
                icon.classList.remove('loading');
                
                if (iconUrl) {
                    const img = document.createElement('img');
                    img.src = iconUrl;
                    img.alt = bookmark.title;
                    img.onload = () => {
                        console.log(`âœ… å›¾æ ‡åŠ è½½æˆåŠŸ: ${bookmark.title} (${loadTime}ms)`);
                    };
                    img.onerror = () => {
                        console.log(`âŒ å›¾æ ‡æ˜¾ç¤ºå¤±è´¥: ${bookmark.title}`);
                        icon.textContent = bookmark.title.charAt(0);
                        icon.style.backgroundColor = '#007bff';
                        icon.style.color = 'white';
                        icon.style.fontWeight = 'bold';
                    };
                    icon.appendChild(img);
                } else {
                    console.log(`ğŸ”¤ ä½¿ç”¨æ–‡å­—å›¾æ ‡: ${bookmark.title} (${loadTime}ms)`);
                    icon.textContent = bookmark.title.charAt(0);
                    icon.style.backgroundColor = '#6c757d';
                    icon.style.color = 'white';
                    icon.style.fontWeight = 'bold';
                }
            });
        }

        // æµ‹è¯•ä¹¦ç­¾åŠ è½½
        function testBookmarks() {
            console.log('ğŸš€ å¼€å§‹æµ‹è¯•ä¹¦ç­¾å›¾æ ‡åŠ è½½...');
            
            const grid = document.getElementById('bookmarkGrid');
            grid.innerHTML = '';
            
            testBookmarks.forEach(bookmark => {
                renderBookmarkIcon(bookmark, grid);
            });
        }

        // æ¸…ç©ºç¼“å­˜
        function clearCache() {
            console.log('ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç¼“å­˜...');
            
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('icon_cache_')) {
                    localStorage.removeItem(key);
                }
            });
            
            console.log(`æ¸…ç©ºäº† ${keys.filter(k => k.startsWith('icon_cache_')).length} ä¸ªç¼“å­˜æ¡ç›®`);
        }

        // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
        function showCacheStats() {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(k => k.startsWith('icon_cache_'));
            
            let validatedCount = 0;
            let totalSize = 0;
            
            cacheKeys.forEach(key => {
                const data = JSON.parse(localStorage.getItem(key));
                if (data.isValidated) validatedCount++;
                totalSize += JSON.stringify(data).length;
            });
            
            const stats = {
                totalEntries: cacheKeys.length,
                validatedEntries: validatedCount,
                totalSize: `${(totalSize / 1024).toFixed(2)} KB`,
                hitRate: cacheKeys.length > 0 ? `${(validatedCount / cacheKeys.length * 100).toFixed(1)}%` : '0%'
            };
            
            const statsContainer = document.getElementById('cacheStats');
            statsContainer.innerHTML = `
                <div class="cache-stat"><strong>æ€»ç¼“å­˜æ¡ç›®:</strong> ${stats.totalEntries}</div>
                <div class="cache-stat"><strong>å·²éªŒè¯æ¡ç›®:</strong> ${stats.validatedEntries}</div>
                <div class="cache-stat"><strong>ç¼“å­˜å¤§å°:</strong> ${stats.totalSize}</div>
                <div class="cache-stat"><strong>éªŒè¯å‘½ä¸­ç‡:</strong> ${stats.hitRate}</div>
            `;
            
            console.log('ğŸ“ˆ ç¼“å­˜ç»Ÿè®¡:', stats);
        }

        // æµ‹è¯•å•ä¸ªå›¾æ ‡
        async function testSingleIcon() {
            const url = prompt('è¯·è¾“å…¥è¦æµ‹è¯•çš„ç½‘ç«™URL:', 'https://www.google.com');
            if (!url) return;
            
            console.log(`ğŸ” å•ç‹¬æµ‹è¯•å›¾æ ‡: ${url}`);
            
            // ç¬¬ä¸€æ¬¡åŠ è½½
            console.log('--- ç¬¬ä¸€æ¬¡åŠ è½½ ---');
            const start1 = performance.now();
            const result1 = await loadIcon(url);
            const time1 = performance.now() - start1;
            
            // ç¬¬äºŒæ¬¡åŠ è½½
            console.log('--- ç¬¬äºŒæ¬¡åŠ è½½ ---');
            const start2 = performance.now();
            const result2 = await loadIcon(url);
            const time2 = performance.now() - start2;
            
            console.log(`ğŸ“Š æ€§èƒ½å¯¹æ¯”:`);
            console.log(`  ç¬¬ä¸€æ¬¡: ${time1.toFixed(2)}ms`);
            console.log(`  ç¬¬äºŒæ¬¡: ${time2.toFixed(2)}ms`);
            console.log(`  æå‡: ${time1 > 0 ? ((time1 - time2) / time1 * 100).toFixed(1) : 0}%`);
            console.log(`  ç¼“å­˜å‘½ä¸­: ${result1 === result2 && time2 < 10 ? 'âœ… æ˜¯' : 'âŒ å¦'}`);
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeLogging();
            showCacheStats();
            console.log('ğŸ› ï¸ å›¾æ ‡ç¼“å­˜æµ‹è¯•é¡µé¢å·²å°±ç»ª');
            console.log('ğŸ’¡ å»ºè®®æµ‹è¯•æµç¨‹:');
            console.log('1. ç‚¹å‡»"æµ‹è¯•ä¹¦ç­¾å›¾æ ‡"è§‚å¯Ÿé¦–æ¬¡åŠ è½½');
            console.log('2. å†æ¬¡ç‚¹å‡»"æµ‹è¯•ä¹¦ç­¾å›¾æ ‡"è§‚å¯Ÿç¼“å­˜æ•ˆæœ');
            console.log('3. ä½¿ç”¨"æµ‹è¯•å•ä¸ªå›¾æ ‡"å¯¹æ¯”æ€§èƒ½');
        });
    </script>
</body>
</html>