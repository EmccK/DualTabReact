<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图标缓存测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .bookmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .bookmark-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .bookmark-item:hover {
            transform: scale(1.05);
        }
        .bookmark-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            position: relative;
        }
        .bookmark-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .bookmark-icon.loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .bookmark-title {
            font-size: 12px;
            color: #333;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .test-controls {
            margin: 20px 0;
        }
        .test-controls button {
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        .test-controls button:hover {
            background: #0056b3;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .cache-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .cache-stat {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
        }
        .cache-stat strong {
            color: #495057;
        }
    </style>
</head>
<body>
    <h1>📊 图标缓存测试页面</h1>
    
    <div class="test-section">
        <h2>🎯 成功URL记忆测试</h2>
        <p>这个测试会验证图标的成功URL记忆功能。首次加载需要尝试多个URL，之后应该直接使用成功的URL。</p>
        
        <div class="test-controls">
            <button onclick="testBookmarks()">🚀 测试书签图标</button>
            <button onclick="clearCache()">🗑️ 清空缓存</button>
            <button onclick="showCacheStats()">📈 查看缓存统计</button>
            <button onclick="testSingleIcon()">🔍 测试单个图标</button>
        </div>
        
        <div class="cache-stats" id="cacheStats"></div>
        
        <div class="bookmark-grid" id="bookmarkGrid"></div>
    </div>
    
    <div class="test-section">
        <h2>📝 测试日志</h2>
        <div class="log-output" id="logOutput"></div>
    </div>

    <script>
        // 测试书签数据
        const testBookmarks = [
            { title: 'Google', url: 'https://www.google.com' },
            { title: 'GitHub', url: 'https://github.com' },
            { title: 'Stack Overflow', url: 'https://stackoverflow.com' },
            { title: 'MDN', url: 'https://developer.mozilla.org' },
            { title: 'Baidu', url: 'https://www.baidu.com' },
            { title: 'Zhihu', url: 'https://www.zhihu.com' },
        ];

        let logContainer = null;
        let originalConsoleLog = null;

        // 初始化日志拦截
        function initializeLogging() {
            logContainer = document.getElementById('logOutput');
            originalConsoleLog = console.log;
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                if (logContainer) {
                    const timestamp = new Date().toLocaleTimeString();
                    logContainer.textContent += `[${timestamp}] ${message}\n`;
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            };
        }

        // 模拟图标加载函数
        async function loadIcon(url, size = 32) {
            console.log(`🔄 开始加载图标: ${url}`);
            
            // 模拟检查验证缓存
            const cached = localStorage.getItem(`icon_cache_${url}_${size}`);
            if (cached) {
                const cacheData = JSON.parse(cached);
                if (cacheData.isValidated && Date.now() - cacheData.timestamp < 7 * 24 * 60 * 60 * 1000) {
                    console.log(`🎯 使用已验证缓存: ${url} -> ${cacheData.iconUrl}`);
                    return cacheData.iconUrl;
                }
            }
            
            // 模拟fallback URL测试
            const fallbackUrls = [
                `${new URL(url).origin}/favicon.ico`,
                `${new URL(url).origin}/favicon.png`,
                `${new URL(url).origin}/apple-touch-icon.png`,
                `https://icons.duckduckgo.com/ip3/${new URL(url).hostname}.ico`,
            ];
            
            for (let i = 0; i < fallbackUrls.length; i++) {
                const testUrl = fallbackUrls[i];
                console.log(`🔄 尝试URL (${i + 1}/${fallbackUrls.length}): ${testUrl}`);
                
                try {
                    const success = await testImageUrl(testUrl);
                    if (success) {
                        console.log(`💾 保存成功URL到验证缓存: ${url} -> ${testUrl}`);
                        
                        // 保存到验证缓存
                        localStorage.setItem(`icon_cache_${url}_${size}`, JSON.stringify({
                            iconUrl: testUrl,
                            timestamp: Date.now(),
                            isValidated: true
                        }));
                        
                        return testUrl;
                    }
                } catch (e) {
                    console.log(`❌ URL失败: ${testUrl}`);
                }
            }
            
            console.log(`💥 所有fallback URL都失败了: ${url}`);
            return null;
        }

        // 测试图片URL是否可用
        function testImageUrl(url, timeout = 3000) {
            return new Promise((resolve) => {
                const img = new Image();
                const timer = setTimeout(() => resolve(false), timeout);
                
                img.onload = () => {
                    clearTimeout(timer);
                    resolve(img.width > 1 && img.height > 1);
                };
                
                img.onerror = () => {
                    clearTimeout(timer);
                    resolve(false);
                };
                
                img.src = url;
            });
        }

        // 渲染书签图标
        function renderBookmarkIcon(bookmark, container) {
            const item = document.createElement('div');
            item.className = 'bookmark-item';
            
            const icon = document.createElement('div');
            icon.className = 'bookmark-icon loading';
            
            const title = document.createElement('div');
            title.className = 'bookmark-title';
            title.textContent = bookmark.title;
            title.title = bookmark.url;
            
            item.appendChild(icon);
            item.appendChild(title);
            container.appendChild(item);
            
            // 开始加载图标
            const startTime = performance.now();
            loadIcon(bookmark.url).then(iconUrl => {
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(2);
                
                icon.classList.remove('loading');
                
                if (iconUrl) {
                    const img = document.createElement('img');
                    img.src = iconUrl;
                    img.alt = bookmark.title;
                    img.onload = () => {
                        console.log(`✅ 图标加载成功: ${bookmark.title} (${loadTime}ms)`);
                    };
                    img.onerror = () => {
                        console.log(`❌ 图标显示失败: ${bookmark.title}`);
                        icon.textContent = bookmark.title.charAt(0);
                        icon.style.backgroundColor = '#007bff';
                        icon.style.color = 'white';
                        icon.style.fontWeight = 'bold';
                    };
                    icon.appendChild(img);
                } else {
                    console.log(`🔤 使用文字图标: ${bookmark.title} (${loadTime}ms)`);
                    icon.textContent = bookmark.title.charAt(0);
                    icon.style.backgroundColor = '#6c757d';
                    icon.style.color = 'white';
                    icon.style.fontWeight = 'bold';
                }
            });
        }

        // 测试书签加载
        function testBookmarks() {
            console.log('🚀 开始测试书签图标加载...');
            
            const grid = document.getElementById('bookmarkGrid');
            grid.innerHTML = '';
            
            testBookmarks.forEach(bookmark => {
                renderBookmarkIcon(bookmark, grid);
            });
        }

        // 清空缓存
        function clearCache() {
            console.log('🗑️ 清空所有缓存...');
            
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('icon_cache_')) {
                    localStorage.removeItem(key);
                }
            });
            
            console.log(`清空了 ${keys.filter(k => k.startsWith('icon_cache_')).length} 个缓存条目`);
        }

        // 显示缓存统计
        function showCacheStats() {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(k => k.startsWith('icon_cache_'));
            
            let validatedCount = 0;
            let totalSize = 0;
            
            cacheKeys.forEach(key => {
                const data = JSON.parse(localStorage.getItem(key));
                if (data.isValidated) validatedCount++;
                totalSize += JSON.stringify(data).length;
            });
            
            const stats = {
                totalEntries: cacheKeys.length,
                validatedEntries: validatedCount,
                totalSize: `${(totalSize / 1024).toFixed(2)} KB`,
                hitRate: cacheKeys.length > 0 ? `${(validatedCount / cacheKeys.length * 100).toFixed(1)}%` : '0%'
            };
            
            const statsContainer = document.getElementById('cacheStats');
            statsContainer.innerHTML = `
                <div class="cache-stat"><strong>总缓存条目:</strong> ${stats.totalEntries}</div>
                <div class="cache-stat"><strong>已验证条目:</strong> ${stats.validatedEntries}</div>
                <div class="cache-stat"><strong>缓存大小:</strong> ${stats.totalSize}</div>
                <div class="cache-stat"><strong>验证命中率:</strong> ${stats.hitRate}</div>
            `;
            
            console.log('📈 缓存统计:', stats);
        }

        // 测试单个图标
        async function testSingleIcon() {
            const url = prompt('请输入要测试的网站URL:', 'https://www.google.com');
            if (!url) return;
            
            console.log(`🔍 单独测试图标: ${url}`);
            
            // 第一次加载
            console.log('--- 第一次加载 ---');
            const start1 = performance.now();
            const result1 = await loadIcon(url);
            const time1 = performance.now() - start1;
            
            // 第二次加载
            console.log('--- 第二次加载 ---');
            const start2 = performance.now();
            const result2 = await loadIcon(url);
            const time2 = performance.now() - start2;
            
            console.log(`📊 性能对比:`);
            console.log(`  第一次: ${time1.toFixed(2)}ms`);
            console.log(`  第二次: ${time2.toFixed(2)}ms`);
            console.log(`  提升: ${time1 > 0 ? ((time1 - time2) / time1 * 100).toFixed(1) : 0}%`);
            console.log(`  缓存命中: ${result1 === result2 && time2 < 10 ? '✅ 是' : '❌ 否'}`);
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeLogging();
            showCacheStats();
            console.log('🛠️ 图标缓存测试页面已就绪');
            console.log('💡 建议测试流程:');
            console.log('1. 点击"测试书签图标"观察首次加载');
            console.log('2. 再次点击"测试书签图标"观察缓存效果');
            console.log('3. 使用"测试单个图标"对比性能');
        });
    </script>
</body>
</html>