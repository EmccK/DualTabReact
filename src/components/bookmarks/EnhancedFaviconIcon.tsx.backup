/**
 * å¢å¼ºçš„Faviconå›¾æ ‡ç»„ä»¶
 * æ”¯æŒæ™ºèƒ½åŠ è½½ã€å¤šæºfallbackã€å¹¶å‘åŠ è½½ç­‰ç‰¹æ€§
 */

import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Globe, AlertCircle, Loader2 } from 'lucide-react';
import { loadBestFaviconUrl, extractDomain, isInternalDomain } from '@/utils/icon-utils';
import { ICON_RETRY_CONFIG } from '@/constants/icon.constants';

interface EnhancedFaviconIconProps {
  url: string;
  title: string;
  size?: number;
  borderRadius?: number;
  className?: string;
  style?: React.CSSProperties;
  onLoad?: (url: string) => void;
  onError?: (error: Error) => void;
  showLoadingState?: boolean;
  fallbackToText?: boolean;
}

type LoadingState = 'idle' | 'loading' | 'loaded' | 'error';

const EnhancedFaviconIcon: React.FC<EnhancedFaviconIconProps> = ({
  url,
  title,
  size = 32,
  borderRadius = 8,
  className = '',
  style = {},
  onLoad,
  onError,
  showLoadingState = true,
  fallbackToText = true,
}) => {
  const [loadingState, setLoadingState] = useState<LoadingState>('idle');
  const [faviconUrl, setFaviconUrl] = useState<string>('');
  const [error, setError] = useState<Error | null>(null);
  const abortControllerRef = useRef<AbortController | null>(null);
  const mountedRef = useRef(true);

  // æ¸…ç†å‡½æ•°
  useEffect(() => {
    return () => {
      mountedRef.current = false;
      if (abortControllerRef.current) {
        abortControllerRef.current.abort();
      }
    };
  }, []);

  // åŠ è½½å›¾æ ‡ - ç®€åŒ–ç‰ˆæœ¬
  const loadFavicon = useCallback(async () => {
    if (!url || !mountedRef.current) return;

    setLoadingState('loading');
    setError(null);

    try {
      // ç®€åŒ–ï¼šç›´æ¥ä½¿ç”¨Google Favicons APIï¼Œè¿™æ˜¯æœ€ç¨³å®šçš„
      const domain = extractDomain(url);

      // æ£€æŸ¥æ˜¯å¦æ˜¯å†…ç½‘åœ°å€
      if (isInternalDomain(domain)) {
        setFaviconUrl('ğŸ ');
        setLoadingState('loaded');
        return;
      }

      const faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=${size}`;

      // ç®€å•çš„å›¾ç‰‡åŠ è½½æµ‹è¯•
      const img = new Image();
      img.onload = () => {
        if (mountedRef.current) {
          setFaviconUrl(faviconUrl);
          setLoadingState('loaded');
          onLoad?.(faviconUrl);
        }
      };
      img.onerror = () => {
        if (mountedRef.current) {
          setLoadingState('error');
          setError(new Error('Failed to load favicon'));
          onError?.(new Error('Failed to load favicon'));
        }
      };
      img.src = faviconUrl;

    } catch (err) {
      if (!mountedRef.current) return;

      const error = err instanceof Error ? err : new Error('Unknown error');
      setError(error);
      setLoadingState('error');
      onError?.(error);
    }
  }, [url, size]); // ç§»é™¤ onLoad å’Œ onError ä¾èµ–ï¼Œé¿å…æ— é™é‡æ–°æ¸²æŸ“

  // å½“URLå˜åŒ–æ—¶é‡æ–°åŠ è½½
  useEffect(() => {
    loadFavicon();
  }, [loadFavicon]);

  // æ ·å¼é…ç½®
  const containerStyle: React.CSSProperties = {
    width: size,
    height: size,
    borderRadius: `${borderRadius}px`,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    overflow: 'hidden',
    flexShrink: 0,
    ...style,
  };

  const imageStyle: React.CSSProperties = {
    width: '100%',
    height: '100%',
    objectFit: 'contain',
  };

  // æ¸²æŸ“åŠ è½½çŠ¶æ€
  if (loadingState === 'loading' && showLoadingState) {
    return (
      <div
        className={`bg-gray-100 ${className}`}
        style={containerStyle}
      >
        <Loader2 
          size={size * 0.4} 
          className="text-gray-400 animate-spin" 
        />
      </div>
    );
  }

  // æ¸²æŸ“æˆåŠŸçŠ¶æ€
  if (loadingState === 'loaded' && faviconUrl) {
    // å¦‚æœæ˜¯emojiæˆ–æ–‡å­—å›¾æ ‡
    if (!faviconUrl.startsWith('http')) {
      return (
        <div
          className={`bg-blue-50 text-blue-600 font-medium ${className}`}
          style={{
            ...containerStyle,
            fontSize: size * 0.5,
          }}
        >
          {faviconUrl}
        </div>
      );
    }

    // å¦‚æœæ˜¯å›¾ç‰‡URL
    return (
      <div
        className={`bg-white ${className}`}
        style={containerStyle}
      >
        <img
          src={faviconUrl}
          alt={title}
          style={imageStyle}
          onError={() => {
            if (mountedRef.current) {
              setLoadingState('error');
              setError(new Error('Image load failed'));
            }
          }}
        />
      </div>
    );
  }

  // æ¸²æŸ“é”™è¯¯çŠ¶æ€
  if (loadingState === 'error') {
    const domain = extractDomain(url);
    const isInternal = isInternalDomain(domain);
    
    // å¦‚æœå¯ç”¨æ–‡å­—å›é€€ï¼Œæ˜¾ç¤ºæ–‡å­—å›¾æ ‡
    if (fallbackToText) {
      const fallbackText = title.slice(0, 2).toUpperCase() || '??';
      return (
        <div
          className={`bg-gradient-to-br from-blue-500 to-blue-600 text-white font-bold ${className}`}
          style={{
            ...containerStyle,
            fontSize: size * 0.35,
          }}
          title={`æ— æ³•åŠ è½½ ${domain} çš„å›¾æ ‡`}
        >
          {fallbackText}
        </div>
      );
    }

    // æ˜¾ç¤ºé»˜è®¤å›¾æ ‡
    return (
      <div
        className={`bg-gray-100 ${className}`}
        style={containerStyle}
        title={`æ— æ³•åŠ è½½ ${domain} çš„å›¾æ ‡`}
      >
        {isInternal ? (
          <div className="text-orange-500 text-lg">ğŸ </div>
        ) : (
          <Globe size={size * 0.6} className="text-gray-400" />
        )}
        {process.env.NODE_ENV === 'development' && (
          <AlertCircle 
            size={size * 0.2} 
            className="absolute -top-1 -right-1 text-red-500" 
            title={error?.message}
          />
        )}
      </div>
    );
  }

  // é»˜è®¤çŠ¶æ€ï¼ˆidleï¼‰
  return (
    <div
      className={`bg-gray-100 ${className}`}
      style={containerStyle}
    >
      <Globe size={size * 0.6} className="text-gray-400" />
    </div>
  );
};

export default EnhancedFaviconIcon;
