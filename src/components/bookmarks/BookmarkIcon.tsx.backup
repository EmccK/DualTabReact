/**
 * ä¹¦ç­¾å›¾æ ‡ç»„ä»¶
 * æ”¯æŒæ–‡å­—ã€å›¾ç‰‡ã€faviconä¸‰ç§ç±»å‹
 */

import React from 'react';
import { colorWithOpacity } from '@/utils/gradient/customGradientUtils';
import { extractDomain, isInternalDomain } from '@/utils/icon-utils';
import type { BookmarkItem } from '@/types/bookmark-style.types';
import type { Bookmark } from '@/types';

interface BookmarkIconProps {
  bookmark: BookmarkItem | Bookmark;
  size: number;
  borderRadius: number;
  className?: string;
}

const BookmarkIcon: React.FC<BookmarkIconProps> = ({
  bookmark,
  size,
  borderRadius,
  className = '',
}) => {
  const iconStyle: React.CSSProperties = {
    width: size,
    height: size,
    borderRadius: `${borderRadius}px`,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: Math.round(size * 0.4),
    fontWeight: 'bold',
    color: 'white',
    overflow: 'hidden',
    flexShrink: 0,
  };

  // ç»Ÿä¸€å›¾æ ‡ç±»å‹å¤„ç†
  const getIconType = () => {
    if (!bookmark.iconType) return 'favicon';
    if (bookmark.iconType === 'official') return 'favicon';
    if (bookmark.iconType === 'upload') return 'image';
    return bookmark.iconType;
  };

  const iconType = getIconType();

  // è·å–å›¾æ ‡å›¾ç‰‡URL
  const getIconImage = () => {
    // å¯¹äºBookmarkç±»å‹ï¼Œå¯èƒ½æœ‰iconDataå­—æ®µ
    if ('iconData' in bookmark && bookmark.iconData) {
      return bookmark.iconData;
    }
    // å¯¹äºBookmarkItemç±»å‹ï¼Œä½¿ç”¨iconImageå­—æ®µ
    if ('iconImage' in bookmark && bookmark.iconImage) {
      return bookmark.iconImage;
    }
    // å¯¹äºBookmarkç±»å‹ï¼Œå¯èƒ½æœ‰iconå­—æ®µ
    if ('icon' in bookmark && bookmark.icon) {
      return bookmark.icon;
    }
    return null;
  };

  // æ¸²æŸ“æ–‡å­—å›¾æ ‡
  if (iconType === 'text') {
    const backgroundColor = bookmark.iconColor || '#3b82f6';
    const text = bookmark.iconText || bookmark.title.slice(0, 2);

    return (
      <div
        className={`${className}`}
        style={{
          ...iconStyle,
          backgroundColor,
        }}
      >
        <span style={{
          lineHeight: 1,
          whiteSpace: 'nowrap',
          fontSize: text.length > 2 ? Math.round(size * 0.3) : Math.round(size * 0.4),
        }}>
          {text}
        </span>
      </div>
    );
  }

  // æ¸²æŸ“å›¾ç‰‡å›¾æ ‡
  if (iconType === 'image') {
    const iconImage = getIconImage();
    if (iconImage) {
      // è·å–èƒŒæ™¯é¢œè‰²é…ç½®
      const backgroundColor = bookmark.imageScale?.backgroundColor;
      const backgroundOpacity = bookmark.imageScale?.backgroundOpacity ?? 100;

      // å¤„ç†èƒŒæ™¯é¢œè‰²ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®æˆ–é€æ˜åº¦ä¸º0ï¼Œåˆ™ä½¿ç”¨é€æ˜èƒŒæ™¯
      const rgbaBackground = backgroundColor && backgroundOpacity > 0
        ? colorWithOpacity(backgroundColor, backgroundOpacity)
        : 'transparent';

      return (
        <div
          className={`${className}`}
          style={{
            ...iconStyle,
            backgroundColor: rgbaBackground,
          }}
        >
          <img
            src={iconImage}
            alt={bookmark.title}
            style={{
              width: '100%',
              height: '100%',
              objectFit: 'cover',
              borderRadius: `${borderRadius}px`,
            }}
            onError={(e) => {
              // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºæ–‡å­—
              const target = e.target as HTMLImageElement;
              const parent = target.parentElement;
              if (parent) {
                parent.innerHTML = bookmark.title.slice(0, 2);
                parent.style.backgroundColor = bookmark.iconColor || '#3b82f6';
              }
            }}
          />
        </div>
      );
    }
  }

  // æ¸²æŸ“faviconå›¾æ ‡ - ç®€åŒ–ç‰ˆæœ¬
  if (iconType === 'favicon') {
    const domain = extractDomain(bookmark.url);

    // å†…ç½‘åœ°å€æ˜¾ç¤ºç‰¹æ®Šå›¾æ ‡
    if (isInternalDomain(domain)) {
      return (
        <div
          className={`${className} bg-orange-50 text-orange-600 font-medium`}
          style={{
            ...iconStyle,
            fontSize: size * 0.5,
          }}
        >
          ğŸ 
        </div>
      );
    }

    // ä½¿ç”¨Google Favicons API
    const faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=${Math.min(size, 64)}`;

    return (
      <div
        className={`${className} bg-white`}
        style={{
          ...iconStyle,
          padding: size * 0.1,
        }}
      >
        <img
          src={faviconUrl}
          alt={bookmark.title}
          style={{
            width: '100%',
            height: '100%',
            objectFit: 'contain',
            borderRadius: `${borderRadius * 0.5}px`,
          }}
          onError={(e) => {
            // faviconåŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºæ–‡å­—
            const target = e.target as HTMLImageElement;
            const parent = target.parentElement;
            if (parent) {
              parent.innerHTML = bookmark.title.slice(0, 2).toUpperCase();
              parent.style.backgroundColor = bookmark.iconColor || '#3b82f6';
              parent.style.color = 'white';
              parent.style.padding = '0';
              parent.style.fontSize = `${size * 0.35}px`;
            }
          }}
        />
      </div>
    );
  }

  // é»˜è®¤æ–‡å­—å›¾æ ‡
  return (
    <div
      className={`${className}`}
      style={{
        ...iconStyle,
        backgroundColor: bookmark.iconColor || '#3b82f6',
      }}
    >
      {bookmark.title.slice(0, 2)}
    </div>
  );
};

export default BookmarkIcon;
